# Overview

This repository contains code used for the publication *Combined translation initiation and termination site ribosome profiling precisely defines novel small and alternative reading frames in a model cyanobacterium* [DOI](TODO).

This includes 3 parts:
 - `metagene_analysis`: Scripts for performing ribosome density analysis.
 - `locus_extraction`: Scripts to extract locus information for specific positions in density plots.
 - `weblogo`: Scripts for generating weblogos from genome sequences.


# Metagene Analysis

The metagene analysis consists of the generation of per-position read-density plots.

1. Input annotation files are read and CDS features are extracted.
2. User-defined filters are applied to the CDS features, these include overlap, length and minimum coverage filters (RPKM).
3. Then windows are defined based on start and stop codon positions of the filtered CDS.
4. Aligned reads are read directly from alignement files and counted per read_length, position and locus.
5. Read Counts are collected per window, collected in a dataframe and returned as an output Excel table.
6. Dataframes are used for plotting.

Additionally, the `metagene_plotting.py` script allows directly using pre-processed loci.json files (generated in step 4.) to directly plot data with substantially lower runtime.

Be aware that this script can run for several minutes, depending on the amount and size of the provided `.bam` files.

## Requirements

These scripts require:

- python3 >= 3.14.0
- pysam >= 0.23.3
- pandas >= 2.3.3
- numpy >= 2.4.3
- pyyam >= 0.23.3
- interlap >= 0.2.7
- xlsxwriter >= 3.2.9

Other versions may work, but the scripts were tested on the indicated versions.

We recommend `mamba` to install the exact requirements used during development.
If you intend to use all scripts in this repository, use the `combined.yml` instead.

```
mamba create -f conda_envs/metagene_profiling.yml
```

## Usage

To use the script, simply create a custom `config.yml` using the provided `config_sample.yml` file.
Then simply call the script.

```
python3 metagene_profiling.py -c my_config.yml
```

The `metagene_plotting` script requires the intermediate files generated by the `metagene_profiling` script but allow faster replotting and excel file generation.

```
python3 metagene_plotting.py -c config.yaml -i path_to_profiling_json  -o path_to_plot_folder
```

### Config file

The config file contains all the information for the experimental used.


| Field Name | Explanation |
|------------|-------------|
| `alignmentDirPath` | Path to the folder containing BAM alignment files |
| `annotationFilePath` | Path to the GFF annotation file |
| `genomeFilePath` | Path to the genome reference file |
| `outputDirPath` | Path to the folder where output files will be saved |
| `positionsOutsideORF` | Number of nucleotides upstream (downstream for stop) of each annotated ORF to include in the metagene profiling window (default: 50) |
| `positionsInsideORF` | Number of nucleotides within each annotated ORF to include in the metagene profiling window (default: 50) |
| `filteringMethods` | List of methods to filter the input annotation before metagene profiling (options: overlap, length, and/or rpkm) |
| `neighboringGenesDistance` | Distance (in nucleotides) around each gene to consider when removing overlapping genes; 0 removes only directly overlapping genes (default: 50) |
| `rpkmThreshold` | Minimum RPKM value threshold for filtering ORFs (default: 10.0) |
| `lengthCutoff` | Minimum length of ORFs to consider; ORFs smaller than `positionsInORF` are automatically filtered (default: 50) |
| `mappingMethods` | Methods for mapping reads to ORFs (options: fiveprime, threeprime, centered, global) |
| `readLengths` | Comma-separated string of read lengths to consider; supports intervals with "-" symbol (e.g., "16-18,23-25") |
| `normalizationMethods` | Method for normalizing read counts (options: raw = no normalization, cpm = counts per million, window = normalized by total counts and window length) |
| `outputFormats` | File formats for plot output (options: svg, pdf, png, jpg, interactive) |
| `includePlotlyJS` | How to include plotly.js in interactive HTML files (options: integrated = embed ~3.7MB per file, online = reference online version requiring internet, local = reference local copy) |
| `colorList` | Custom list of colors for plots; must have at least as many colors as read lengths; if empty, uses color-blind friendly colors automatically |

