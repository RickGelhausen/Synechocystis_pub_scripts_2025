# Overview

This repository contains code used for the publication *Combined translation initiation and termination site ribosome profiling precisely defines novel small and alternative reading frames in a model cyanobacterium* [DOI](TODO).

This includes 3 parts:
 - `metagene_analysis`: Scripts for performing ribosome density analysis.
 - `locus_extraction`: Scripts to extract locus information for specific positions in density plots.
 - `weblogo`: Scripts for generating weblogos from genome sequences.


# Requirements

To run all the scripts, you will require the following tools/libraries.

- python >= 3.14.0
- pysam >= 0.23.3
- pandas >= 2.3.3
- numpy >= 2.3.4
- biopython >= 1.8.6
- interlap >= 0.2.7
- openpyxl >= 3.1.5
- weblogo >= 3.7.9
- xlsxwriter >= 3.2.9
- xlrd >= 2.0.2
- python-kaleido >= 1.2.0
- pytest >= 8.4.2
- pytest-mock >= 3.15.1
- pyyaml >= 6.0.3
- plotly >= 6.3.1

Other versions may work, but the scripts were tested on the indicated versions.


We recommend using `uv`. Read more about this [here](https://github.com/astral-sh/uv).

```
uv sync
```

Afterwards, activate the environment via:

```
source .venv/bin/activate
```

or run commands directly.

```
uv run <command>
```

Alternatively, you can use `mamba` (see [guide](https://mamba.readthedocs.io/en/latest/user_guide/mamba.html)) to install the exact requirements used during development.


```
mamba create -f metagene_profiling.yml
```

Then activate the environment.

```
mamba activate metagene_profiling
```

# Metagene Analysis

The metagene analysis consists of the generation of per-position read-density plots.

1. Input annotation files are read and CDS features are extracted.
2. User-defined filters are applied to the CDS features, these include overlap, length and minimum coverage filters (RPKM).
3. Then windows are defined based on start and stop codon positions of the filtered CDS.
4. Aligned reads are read directly from alignement files and counted per read_length, position and locus.
5. Read Counts are collected per window, collected in a dataframe and returned as an output Excel table.
6. Dataframes are used for plotting.

Additionally, the `metagene_plotting.py` script allows directly using pre-processed loci.json files (generated in step 4.) to directly plot data with substantially lower runtime.

Be aware that this script can run for several minutes, depending on the amount and size of the provided `.bam` files.


## Usage

To use the script, simply create a custom `config.yml` using the provided `config_sample.yml` file.
Then simply call the script.

```
python3 metagene_profiling.py -c my_config.yml
```

The `metagene_plotting` script requires the intermediate files generated by the `metagene_profiling` script but allow faster replotting and excel file generation.

```
python3 metagene_plotting.py -c config.yaml -i path_to_profiling_json_dir  -o path_to_plot_folder
```

### Config file

The config file contains all the information for the experimental used.


| Field Name | Explanation |
|------------|-------------|
| `alignmentDirPath` | Path to the folder containing BAM alignment files |
| `annotationFilePath` | Path to the GFF annotation file |
| `genomeFilePath` | Path to the genome reference file |
| `outputDirPath` | Path to the folder where output files will be saved |
| `positionsOutsideORF` | Number of nucleotides upstream (downstream for stop) of each annotated ORF to include in the metagene profiling window (default: 50) |
| `positionsInsideORF` | Number of nucleotides within each annotated ORF to include in the metagene profiling window (default: 50) |
| `filteringMethods` | List of methods to filter the input annotation before metagene profiling (options: overlap, length, and/or rpkm) |
| `neighboringGenesDistance` | Distance (in nucleotides) around each gene to consider when removing overlapping genes; 0 removes only directly overlapping genes (default: 50) |
| `rpkmThreshold` | Minimum RPKM value threshold for filtering ORFs (default: 10.0) |
| `lengthCutoff` | Minimum length of ORFs to consider; ORFs smaller than `positionsInORF` are automatically filtered (default: 50) |
| `mappingMethods` | Methods for mapping reads to ORFs (options: fiveprime, threeprime, centered, global) |
| `readLengths` | Comma-separated string of read lengths to consider; supports intervals with "-" symbol (e.g., "16-18,23-25") |
| `normalizationMethods` | Method for normalizing read counts (options: raw = no normalization, cpm = counts per million, window = normalized by total counts and window length) |
| `outputFormats` | File formats for plot output (options: svg, pdf, png, jpg, interactive) |
| `includePlotlyJS` | How to include plotly.js in interactive HTML files (options: integrated = embed ~3.7MB per file, online = reference online version requiring internet, local = reference local copy) |
| `colorList` | Custom list of colors for plots; must have at least as many colors as read lengths; if empty, uses color-blind friendly colors automatically |

# Loci Extraction

Following metagene profiling and plot analysis, it may be necessary to investigate the underlying composition of specific peaks observed in the density plot.

To this end, we provide the `extract_locus_data.py` script. This allows specifying specific peak positions and it returns a table containing all loci contributing to this position and the according read-counts.

This can be important as many factors like artifacts from size selection, cDNA synthesis, or sequencing can cause pile-ups of reads that do not reflect genuine biological signals, such as ribosome occupancy or translational stalling.

## Usage

To use this script, you require the intermediate `.json` output files of the `metagene-profiling.py` script. These files contain all the information about each individual data point.

Then you can simply run the script with the desired paramters.

```
python3 locus_extraction/extract_locus_data.py -i=/path/to/your/metagene/files/readcounts_start_threeprime.json -s <sample_name> -r <read_length> -p <position> -o output.xlsx --sort-by count
```


# Weblogo

This contains a script that was used to create weblogos based on observations in the density plots. After extraction of spefic regions with `extract_locus_data.py`. The sequences for the loci in the excel sheet can be extracted and plotted as a weblogo.

Additionally the helper script `merge_xlsx.py` can be used to merge several excel sheets. This was originally intended to merge multiple replicate tables and keep for each loci the best read count.

## Usage

The extraction of the sequences and use of weblogo are combined in a bash script.
Run the following command:

```
bash weblogo/create_logo.sh -x <input>.xlsx -f genome.fa -g annotation.gff -o output_sequences.fa -s output_logo.svg
```

